# config/nginx/web/conf.d/default.conf
# FKS Trading Platform - Web Server Configuration with SSL

# ============================================================================
# HTTP TO HTTPS REDIRECT SERVER
# ============================================================================
server {
    listen 80;
    server_name fkstrading.xyz www.fkstrading.xyz;
    
    # Health check endpoint (always available via HTTP)
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # Let's Encrypt ACME challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
    }
    
    # Redirect all other HTTP traffic to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# ============================================================================
# MAIN HTTPS SERVER - FKS TRADING PLATFORM
# ============================================================================
server {
    listen 443 ssl http2;
    server_name fkstrading.xyz www.fkstrading.xyz;
    
    # Include SSL configuration
    include /etc/nginx/conf.d/ssl.conf;
    
    # Root directory for React build
    root /usr/share/nginx/html;
    index index.html index.htm;
    
    # ========================================================================
    # LOGGING CONFIGURATION
    # ========================================================================
    access_log /var/log/nginx/fks_web_access.log main;
    error_log /var/log/nginx/fks_web_error.log warn;
    
    # ========================================================================
    # SECURITY CONFIGURATION
    # ========================================================================
    
    # Hide nginx version
    server_tokens off;
    
    # Prevent access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Prevent access to sensitive files
    location ~* \.(env|conf|config|log|sql|bak|backup|tmp)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # ========================================================================
    # SPECIAL ENDPOINTS
    # ========================================================================
    
    # Health check endpoint
    location /health {
        access_log off;
        return 200 "FKS Trading Platform - Web Service Healthy\n";
        add_header Content-Type text/plain;
        add_header X-Service-Type "fks_web";
        add_header X-Service-Version "${APP_VERSION}";
    }
    
    # SSL certificate information endpoint
    location /ssl-info {
        access_log off;
        return 200 "SSL certificate active for FKS Trading\n";
        add_header Content-Type text/plain;
        add_header X-SSL-Subject "$ssl_client_s_dn";
        add_header X-SSL-Issuer "$ssl_client_i_dn";
    }
    
    # Service status endpoint
    location /status {
        access_log off;
        return 200 '{"service":"fks_web","status":"healthy","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }
    
    # Nginx status (restricted access)
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow ::1;
        # Add your Tailscale network here
        allow 100.64.0.0/10;
        deny all;
    }
    
    # ========================================================================
    # API PROXY CONFIGURATION
    # ========================================================================
    
    # FKS API Proxy (to separate API server)
    location /api/ {
        # Remove /api prefix when forwarding
        rewrite ^/api/(.*) /$1 break;
        
        # Proxy to FKS API server
        proxy_pass https://api.fkstrading.xyz;
        
        # Standard proxy headers
        proxy_set_header Host api.fkstrading.xyz;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # WebSocket support for real-time trading data
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Timeouts for trading operations
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffering
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        
        # CORS headers for trading API
        add_header Access-Control-Allow-Origin "https://fkstrading.xyz" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
    }
    
    # Authentication proxy (to separate auth server)
    location /auth/ {
        # Remove /auth prefix when forwarding
        rewrite ^/auth/(.*) /$1 break;
        
        # Proxy to FKS auth server
        proxy_pass https://auth.fkstrading.xyz;
        
        # Standard proxy headers
        proxy_set_header Host auth.fkstrading.xyz;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Session handling
        proxy_set_header Cookie $http_cookie;
        
        # Timeouts for auth operations
        proxy_connect_timeout 15s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # CORS headers for auth
        add_header Access-Control-Allow-Origin "https://fkstrading.xyz" always;
        add_header Access-Control-Allow-Credentials "true" always;
    }
    
    # ========================================================================
    # STATIC CONTENT HANDLING - REACT SPA
    # ========================================================================
    
    # Static assets (with aggressive caching)
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options nosniff;
        
        # Compress static files
        gzip_static on;
        
        # Security headers for static content
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;
    }
    
    # Service worker (short cache for updates)
    location /service-worker.js {
        expires 0;
        add_header Cache-Control "public, max-age=0, must-revalidate";
        add_header Service-Worker-Allowed "/";
    }
    
    # Manifest and other app files
    location ~* \.(webmanifest|manifest\.json)$ {
        expires 1h;
        add_header Cache-Control "public, max-age=3600";
    }
    
    # React Router - SPA fallback
    location / {
        try_files $uri $uri/ /index.html;
        
        # Security headers for HTML content
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;
        
        # Cache HTML files for shorter period
        expires 1h;
        add_header Cache-Control "public, max-age=3600, must-revalidate";
    }
    
    # ========================================================================
    # TRADING PLATFORM SPECIFIC ROUTES
    # ========================================================================
    
    # Trading dashboard (ensure no caching for real-time data)
    location /dashboard {
        try_files $uri $uri/ /index.html;
        expires 0;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
    }
    
    # Real-time WebSocket endpoint proxy
    location /ws/ {
        proxy_pass https://api.fkstrading.xyz/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host api.fkstrading.xyz;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket specific timeouts
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }
    
    # ========================================================================
    # ERROR PAGES
    # ========================================================================
    
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    location = /404.html {
        root /usr/share/nginx/html;
        internal;
    }
    
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }
}

# ============================================================================
# FALLBACK SERVER (CATCH-ALL)
# ============================================================================
server {
    listen 443 ssl http2 default_server;
    server_name _;
    
    # Include SSL configuration
    include /etc/nginx/conf.d/ssl.conf;
    
    # Return 444 (connection closed) for unknown hosts
    return 444;
}
