worker_processes auto;
events { worker_connections 1024; }
http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;

    # Use Docker DNS resolver for dynamic container name resolution
    resolver 127.0.0.11 ipv6=off valid=30s;

    # Upstream variables (defer DNS resolution until request time)
    set $api_up   http://fks_api:8000;
    set $data_up  http://fks_data:4200;
    set $engine_up http://fks_engine:4300;
    set $web_up   http://fks_web:80;

    server {
        listen 80;
        listen 443 ssl;
        server_name localhost;

        ssl_certificate /etc/nginx/certs/selfsigned.crt;
        ssl_certificate_key /etc/nginx/certs/selfsigned.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        location /health { return 200 'OK'; add_header Content-Type text/plain; }
        location /api/ { proxy_pass $api_up; proxy_set_header Host $host; }
        location /data/ { proxy_pass $data_up; proxy_set_header Host $host; }
        location /engine/ { proxy_pass $engine_up; proxy_set_header Host $host; }
        location / { proxy_pass $web_up; proxy_set_header Host $host; }
    }
}
