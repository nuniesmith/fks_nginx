services:
  nginx:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: nuniesmith/fks:nginx-latest
    container_name: fks-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      # SSL certificates
      - ./ssl:/etc/nginx/ssl:ro
      # Logs
      #- ./logs:/var/log/nginx
      # Static files from Django (if running locally)
      - ../web/staticfiles:/app/staticfiles:ro
      # Media files from Django (if running locally)
      - ../web/media:/app/media:ro
      # Let's Encrypt certificates (if using certbot)
      - certbot_data:/etc/letsencrypt:ro
      # Kubernetes dashboard token (created by run.sh option 6)
      - ../main/k8s/dashboard-token.txt:/etc/nginx/secrets/dashboard-token.txt:ro
    networks:
      - fks-network
    # Note: Services are in separate docker-compose files but share fks-network
    # Ensure web service (fks_web) is running before starting nginx
    # depends_on only works within the same compose file, so we rely on network connectivity
    environment:
      - TZ=American/Toronto
      # Optional: override token via env (takes precedence over file if set)
      - DASHBOARD_TOKEN=${DASHBOARD_TOKEN:-}
    labels:
      - "com.fks.service=nginx"
      - "com.fks.role=reverse-proxy"

  # Optional: Certbot for Let's Encrypt
  certbot:
    image: certbot/certbot:latest
    container_name: fks-certbot
    volumes:
      - certbot_data:/etc/letsencrypt
      - ./ssl:/etc/letsencrypt/ssl:ro
      - ./logs:/var/log/letsencrypt
    command: certonly --webroot --webroot-path=/var/www/certbot --email admin@fkstrading.xyz --agree-tos --no-eff-email -d fkstrading.xyz -d www.fkstrading.xyz
    profiles:
      - ssl

networks:
  fks-network:
    external: true
    name: fks-network

volumes:
  certbot_data:
